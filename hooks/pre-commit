#!/bin/bash
#
# Pre-commit hook for Odoo documentation repo.
# Runs Vale and Sphinx linter against staged .rst files.
#

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BOLD='\033[1m'
RESET='\033[0m'

VALE_REPO="${VALE_REPO:-$HOME/Documents/odoo/odoo-vale-linter}"

# Get staged .rst files (added, copied, or modified)
mapfile -t STAGED_RST < <(git diff --cached --name-only --diff-filter=ACM -- '*.rst')

if [ "${#STAGED_RST[@]}" -eq 0 ]; then
    exit 0
fi

echo -e "${BOLD}Checking staged .rst files...${RESET}"
echo ""

ERRORS=0

# --- Vale ---
if command -v vale &> /dev/null; then
    echo -e "${BOLD}Running Vale...${RESET}"
    VALE_OUTPUT=""
    for file in "${STAGED_RST[@]}"; do
        if [ -f "$file" ]; then
            OUTPUT=$(vale --config="$VALE_REPO/.vale.ini" "$file" 2>&1)
            EXIT_CODE=$?
            if [ "$EXIT_CODE" -ne 0 ]; then
                VALE_OUTPUT+="$OUTPUT"$'\n'
            fi
        fi
    done

    if [ -n "$VALE_OUTPUT" ]; then
        echo "$VALE_OUTPUT"
        echo -e "${RED}✗ Vale found issues${RESET}"
        echo ""
        ERRORS=1
    else
        echo -e "${GREEN}✓ Vale passed${RESET}"
        echo ""
    fi
else
    echo -e "${YELLOW}⚠ Vale not found, skipping style checks${RESET}"
    echo ""
fi

# --- Sphinx linter ---
REPO_ROOT=$(git rev-parse --show-toplevel)
SPHINX_LINTER="$REPO_ROOT/tests/main.py"

if [ -f "$SPHINX_LINTER" ]; then
    if command -v uv &> /dev/null; then
        echo -e "${BOLD}Running Sphinx linter...${RESET}"
        # Pass staged .rst files as arguments
        SPHINX_OUTPUT=$(uv run --with sphinxlint "$SPHINX_LINTER" "${STAGED_RST[@]}" 2>&1)
        SPHINX_EXIT=$?

        if [ "$SPHINX_EXIT" -ne 0 ]; then
            echo "$SPHINX_OUTPUT"
            echo -e "${RED}✗ Sphinx linter found issues${RESET}"
            echo ""
            ERRORS=1
        else
            echo -e "${GREEN}✓ Sphinx linter passed${RESET}"
            echo ""
        fi
    else
        echo -e "${YELLOW}⚠ uv not found, skipping Sphinx linter${RESET}"
        echo ""
    fi
fi

# --- Result ---
if [ "$ERRORS" -ne 0 ]; then
    echo -e "${RED}${BOLD}Commit blocked.${RESET} Fix the issues above or use ${BOLD}git commit --no-verify${RESET} to skip."
    exit 1
fi

echo -e "${GREEN}${BOLD}All checks passed.${RESET}"
exit 0
