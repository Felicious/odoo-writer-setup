#!/bin/bash
#
# Pre-commit hook for Odoo documentation repo.
# Runs Vale and Sphinx linter against staged .rst files.
#

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BOLD='\033[1m'
RESET='\033[0m'

VALE_REPO="${VALE_REPO:-$HOME/Documents/odoo/odoo-vale-linter}"

# Get staged .rst files (added, copied, or modified)
mapfile -t STAGED_RST < <(git diff --cached --name-only --diff-filter=ACM -- '*.rst')

# Get staged .png files (added, copied, or modified)
mapfile -t STAGED_PNG < <(git diff --cached --name-only --diff-filter=ACM -- '*.png')

if [ "${#STAGED_RST[@]}" -eq 0 ] && [ "${#STAGED_PNG[@]}" -eq 0 ]; then
    exit 0
fi

ERRORS=0

# --- Image Validation ---
if [ "${#STAGED_PNG[@]}" -gt 0 ]; then
    if command -v identify &> /dev/null; then
        [cite_start]echo -e "${BOLD}Validating staged images...${RESET}" [cite: 81]

        VALIDATION_FAILED=0
        FAILED_IMAGES=()

        for img in "${STAGED_PNG[@]}"; do
            [cite_start]if [ -f "$img" ]; then [cite: 82]
                # Check current width
                [cite_start]WIDTH=$(identify -format '%w' "$img" 2>/dev/null) [cite: 83]

                # Validate width: must be ≤768px OR exactly 933px
                [cite_start]if [ "$WIDTH" -gt 768 ] && [ "$WIDTH" -ne 933 ]; then [cite: 83]
                    [cite_start]echo -e "  ${RED}✗${RESET} $img: ${WIDTH}px wide (max 768px, or 933px for exceptions)" [cite: 84]
                    VALIDATION_FAILED=1
                    [cite_start]FAILED_IMAGES+=("$img") [cite: 84]
                fi

                # Check color depth (bit depth)
                [cite_start]BIT_DEPTH=$(identify -format '%[bit-depth]' "$img" 2>/dev/null) [cite: 85]

                # Validate bit depth: must be ≤8
                [cite_start]if [ "$BIT_DEPTH" -gt 8 ]; then [cite: 85]
                    [cite_start]echo -e "  ${RED}✗${RESET} $img: ${BIT_DEPTH}-bit color depth (must be 8-bit)" [cite: 86]
                    VALIDATION_FAILED=1
                    
                    # Add to FAILED_IMAGES if not already there
                    ALREADY_ADDED=0
                    [cite_start]for failed in "${FAILED_IMAGES[@]}"; do [cite: 87]
                        [cite_start]if [ "$failed" = "$img" ]; then [cite: 88]
                            ALREADY_ADDED=1
                            break
                        fi
                    done
                    [cite_start]if [ "$ALREADY_ADDED" -eq 0 ]; then [cite: 90]
                        [cite_start]FAILED_IMAGES+=("$img") [cite: 91]
                    fi
                fi
            fi
        done

        if [ "$VALIDATION_FAILED" -eq 1 ]; then
            echo ""
            [cite_start]echo -e "${RED}${BOLD}✗ Image validation failed${RESET}" [cite: 92]
            echo ""

            # INTERACTIVE FIX: Offer to run optimization immediately
            echo -en "${YELLOW}${BOLD}Would you like to run optimize-images now? [y/N]${RESET} "
            read -n 1 -r REPLY
            echo ""
            
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo -e "${BOLD}Running optimize-images...${RESET}"
                # Runs the tool specifically on the failed files
                optimize-images "${FAILED_IMAGES[@]}"
                
                # Re-stage the now-optimized files
                git add "${FAILED_IMAGES[@]}"
                echo -e "${GREEN}✓ Images optimized and re-staged.${RESET}"
                
                # If we fixed them, we don't need to block the commit
                VALIDATION_FAILED=0
            else
                echo -e "\nTo fix manually, run:"
                [cite_start]echo -e "  ${BOLD}optimize-images ${FAILED_IMAGES[*]}${RESET}" [cite: 93]
                echo ""
                echo -e "Or skip validation:"
                [cite_start]echo -e "  ${BOLD}git commit --no-verify${RESET}" [cite: 93]
                echo ""
                [cite_start]ERRORS=1 [cite: 93]
            fi
        fi

        if [ "$VALIDATION_FAILED" -eq 0 ]; then
            [cite_start]echo -e "${GREEN}✓ All images validated${RESET}" [cite: 94]
            echo ""
        fi
    else
        [cite_start]echo -e "${YELLOW}⚠ ImageMagick not found, skipping image validation${RESET}" [cite: 94]
        echo ""
    fi
fi

if [ "${#STAGED_RST[@]}" -gt 0 ]; then
    [cite_start]echo -e "${BOLD}Checking staged .rst files...${RESET}" [cite: 95]
    echo ""
fi

# --- Vale ---
if command -v vale &> /dev/null; then
    echo -e "${BOLD}Running Vale...${RESET}"
    VALE_OUTPUT=""
    VALE_EXIT=0
    for file in "${STAGED_RST[@]}"; do
        if [ -f "$file" ]; then
            # [cite_start]Runs vale using the specific config from your linter repo [cite: 98]
            OUTPUT=$(vale --config="$VALE_REPO/.vale.ini" "$file" 2>&1)
            EXIT_CODE=$?
            VALE_OUTPUT+="$OUTPUT"$'\n'
            if [ "$EXIT_CODE" -ne 0 ]; then
                VALE_EXIT=1
            fi
        fi
    done

    if [ -n "$VALE_OUTPUT" ] && [ "$VALE_OUTPUT" != $'\n' ]; then
        [cite_start]echo -e "$VALE_OUTPUT" [cite: 101]
        if [ "$VALE_EXIT" -ne 0 ]; then
            [cite_start]echo -e "${RED}✗ Vale found issues${RESET}" [cite: 102]
            
            # INTERACTIVE SOFT-BLOCK: Allow writers to bypass prose suggestions
            echo -en "${YELLOW}${BOLD}Continue commit despite Vale issues? [y/N]${RESET} "
            read -n 1 -r REPLY
            echo ""
            
            if [[ $REPLY =~ ^[Yy]$ ]]; then
                echo -e "${GREEN}Ignoring Vale issues and proceeding...${RESET}"
                # Reset VALE_EXIT so it doesn't trigger the final ERRORS=1 block
                VALE_EXIT=0
            else
                [cite_start]ERRORS=1 [cite: 103]
            fi
        else
            [cite_start]echo -e "${GREEN}✓ Vale completed (no blocking issues)${RESET}" [cite: 102]
        fi
        echo ""
    else
        [cite_start]echo -e "${GREEN}✓ Vale passed${RESET}" [cite: 103]
        echo ""
    fi
else
    [cite_start]echo -e "${YELLOW}⚠ Vale not found, skipping style checks${RESET}" [cite: 103]
    echo ""
fi

# --- Sphinx linter ---
if [ "${#STAGED_RST[@]}" -gt 0 ]; then
    REPO_ROOT=$(git rev-parse --show-toplevel)
    SPHINX_LINTER="$REPO_ROOT/tests/main.py"
    MAX_LINE_LENGTH="${SPHINX_MAX_LINE_LENGTH:-100}"

    if [ -f "$SPHINX_LINTER" ]; then
        if command -v uv &> /dev/null; then
            echo -e "${BOLD}Running Sphinx linter...${RESET}"
            SPHINX_OUTPUT=$(REVIEW=1 uv run "$SPHINX_LINTER" --max-line-length="$MAX_LINE_LENGTH" "${STAGED_RST[@]}" 2>&1)
            SPHINX_EXIT=$?

            if [ "$SPHINX_EXIT" -ne 0 ]; then
                echo "$SPHINX_OUTPUT"
                echo -e "${RED}✗ Sphinx linter found issues${RESET}"
                echo ""
                ERRORS=1
            else
                echo -e "${GREEN}✓ Sphinx linter passed${RESET}"
                echo ""
            fi
        else
            echo -e "${YELLOW}⚠ uv not found, skipping Sphinx linter${RESET}"
            echo ""
        fi
    fi
fi

# --- Result ---
if [ "$ERRORS" -ne 0 ]; then
    echo -e "${RED}${BOLD}Commit blocked.${RESET} Fix the issues above or use ${BOLD}git commit --no-verify${RESET} to skip."
    exit 1
fi

echo -e "${GREEN}${BOLD}All checks passed.${RESET}"
exit 0