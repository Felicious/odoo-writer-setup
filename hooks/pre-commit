#!/bin/bash
#
# Pre-commit hook for Odoo documentation repo.
# Runs Vale and Sphinx linter against staged .rst files.
#

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BOLD='\033[1m'
RESET='\033[0m'

VALE_REPO="${VALE_REPO:-$HOME/Documents/odoo/odoo-vale-linter}"

# Get staged .rst files (added, copied, or modified)
mapfile -t STAGED_RST < <(git diff --cached --name-only --diff-filter=ACM -- '*.rst')

# Get staged .png files (added, copied, or modified)
mapfile -t STAGED_PNG < <(git diff --cached --name-only --diff-filter=ACM -- '*.png')

if [ "${#STAGED_RST[@]}" -eq 0 ] && [ "${#STAGED_PNG[@]}" -eq 0 ]; then
    exit 0
fi

ERRORS=0

# --- Image Validation ---
if [ "${#STAGED_PNG[@]}" -gt 0 ]; then
    if command -v identify &> /dev/null; then
        echo -e "${BOLD}Validating staged images...${RESET}"

        VALIDATION_FAILED=0
        FAILED_IMAGES=()

        for img in "${STAGED_PNG[@]}"; do
            if [ -f "$img" ]; then
                # Check current width
                WIDTH=$(identify -format '%w' "$img" 2>/dev/null)

                # Validate width: must be ≤768px OR exactly 933px
                if [ "$WIDTH" -gt 768 ] && [ "$WIDTH" -ne 933 ]; then
                    echo -e "  ${RED}✗${RESET} $img: ${WIDTH}px wide (max 768px, or 933px for exceptions)"
                    VALIDATION_FAILED=1
                    FAILED_IMAGES+=("$img")
                fi

                # Check color depth (bit depth)
                BIT_DEPTH=$(identify -format '%[bit-depth]' "$img" 2>/dev/null)

                # Validate bit depth: must be ≤8
                if [ "$BIT_DEPTH" -gt 8 ]; then
                    echo -e "  ${RED}✗${RESET} $img: ${BIT_DEPTH}-bit color depth (must be 8-bit)"
                    VALIDATION_FAILED=1
                    # Add to FAILED_IMAGES if not already there
                    ALREADY_ADDED=0
                    for failed in "${FAILED_IMAGES[@]}"; do
                        if [ "$failed" = "$img" ]; then
                            ALREADY_ADDED=1
                            break
                        fi
                    done
                    if [ "$ALREADY_ADDED" -eq 0 ]; then
                        FAILED_IMAGES+=("$img")
                    fi
                fi
            fi
        done

        if [ "$VALIDATION_FAILED" -eq 1 ]; then
            echo ""
            echo -e "${RED}${BOLD}✗ Image validation failed${RESET}"
            echo ""
            echo -e "To fix, run:"
            echo -e "  ${BOLD}optimize-images${RESET}"
            echo ""
            echo -e "Or optimize specific files:"
            echo -e "  ${BOLD}optimize-images ${FAILED_IMAGES[*]}${RESET}"
            echo ""
            echo -e "Or skip validation:"
            echo -e "  ${BOLD}git commit --no-verify${RESET}"
            echo ""
            ERRORS=1
        else
            echo -e "${GREEN}✓ All images validated${RESET}"
            echo ""
        fi
    else
        echo -e "${YELLOW}⚠ ImageMagick not found, skipping image validation${RESET}"
        echo ""
    fi
fi

if [ "${#STAGED_RST[@]}" -gt 0 ]; then
    echo -e "${BOLD}Checking staged .rst files...${RESET}"
    echo ""
fi

# --- Vale ---
if command -v vale &> /dev/null; then
    echo -e "${BOLD}Running Vale...${RESET}"
    VALE_OUTPUT=""
    VALE_EXIT=0
    for file in "${STAGED_RST[@]}"; do
        if [ -f "$file" ]; then
            OUTPUT=$(vale --config="$VALE_REPO/.vale.ini" "$file" 2>&1)
            EXIT_CODE=$?
            VALE_OUTPUT+="$OUTPUT"$'\n'
            if [ "$EXIT_CODE" -ne 0 ]; then
                VALE_EXIT=1
            fi
        fi
    done

    if [ -n "$VALE_OUTPUT" ]; then
        echo "$VALE_OUTPUT"
        if [ "$VALE_EXIT" -ne 0 ]; then
            echo -e "${RED}✗ Vale found issues${RESET}"
        else
            echo -e "${GREEN}✓ Vale completed (no blocking issues)${RESET}"
        fi
        echo ""
        if [ "$VALE_EXIT" -ne 0 ]; then
            ERRORS=1
        fi
    else
        echo -e "${GREEN}✓ Vale passed${RESET}"
        echo ""
    fi
else
    echo -e "${YELLOW}⚠ Vale not found, skipping style checks${RESET}"
    echo ""
fi

# --- Sphinx linter ---
REPO_ROOT=$(git rev-parse --show-toplevel)
SPHINX_LINTER="$REPO_ROOT/tests/main.py"
MAX_LINE_LENGTH="${SPHINX_MAX_LINE_LENGTH:-100}"

if [ -f "$SPHINX_LINTER" ]; then
    if command -v uv &> /dev/null; then
        echo -e "${BOLD}Running Sphinx linter...${RESET}"
        SPHINX_OUTPUT=$(REVIEW=1 uv run "$SPHINX_LINTER" --max-line-length="$MAX_LINE_LENGTH" "${STAGED_RST[@]}" 2>&1)
        SPHINX_EXIT=$?

        if [ "$SPHINX_EXIT" -ne 0 ]; then
            echo "$SPHINX_OUTPUT"
            echo -e "${RED}✗ Sphinx linter found issues${RESET}"
            echo ""
            ERRORS=1
        else
            echo -e "${GREEN}✓ Sphinx linter passed${RESET}"
            echo ""
        fi
    else
        echo -e "${YELLOW}⚠ uv not found, skipping Sphinx linter${RESET}"
        echo ""
    fi
fi

# --- Result ---
if [ "$ERRORS" -ne 0 ]; then
    echo -e "${RED}${BOLD}Commit blocked.${RESET} Fix the issues above or use ${BOLD}git commit --no-verify${RESET} to skip."
    exit 1
fi

echo -e "${GREEN}${BOLD}All checks passed.${RESET}"
exit 0
